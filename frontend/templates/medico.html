<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel M√©dico - HCE</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            background: #f8f9fa;
            font-family: "Segoe UI", sans-serif;
        }
        .navbar-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 0;
        }
        .navbar-custom .navbar-brand {
            color: white;
            font-weight: 700;
            font-size: 1.5rem;
        }
        .card-dashboard {
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .card-dashboard:hover {
            transform: translateY(-5px);
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
        }
        .action-btn {
            border-radius: 10px;
            padding: 1rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .search-container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .table-hover tbody tr:hover {
            background-color: #f1f3f5;
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-custom">
        <div class="container-fluid">
            <span class="navbar-brand">üè• Panel M√©dico</span>
            <div class="d-flex align-items-center">
                <span class="text-white me-3">üë®‚Äç‚öïÔ∏è <span id="userName"></span></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">

        <!-- Estad√≠sticas -->
        <div class="row">
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>Total Pacientes</h6>
                            <div class="stat-number" id="totalPacientes">0</div>
                        </div>
                        <div style="font-size: 3rem;">üìä</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>Consultas Hoy</h6>
                            <div class="stat-number" id="consultasHoy">0</div>
                        </div>
                        <div style="font-size: 3rem;">üìÖ</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>Acceso R√°pido</h6>
                            <small>Sistema activo</small>
                        </div>
                        <div style="font-size: 3rem;">‚úÖ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- B√∫squeda de Pacientes -->
        <div class="search-container mb-4">
            <h4 class="mb-3">üîç Buscar Paciente</h4>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Por Documento</label>
                    <div class="input-group">
                        <input type="text" id="searchDoc" class="form-control" placeholder="N√∫mero de documento">
                        <button class="btn btn-primary-custom" onclick="buscarPorDocumento()">Buscar</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Por Nombre</label>
                    <div class="input-group">
                        <input type="text" id="searchNombre" class="form-control" placeholder="Nombre del paciente">
                        <button class="btn btn-primary-custom" onclick="buscarPorNombre()">Buscar</button>
                    </div>
                </div>
            </div>

            <!-- Resultados de b√∫squeda -->
            <div id="searchResults" class="mt-3"></div>
        </div>

        <!-- Acciones R√°pidas -->
        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="card card-dashboard">
                    <div class="card-body text-center">
                        <div style="font-size: 3rem;">‚ûï</div>
                        <h5 class="card-title mt-2">Registrar Paciente</h5>
                        <p class="card-text">Crear nueva historia cl√≠nica</p>
                        <button class="btn btn-primary-custom w-100" onclick="window.location.href='registrar_paciente.html'">
                            Ir al Registro
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-4 mb-3">
                <div class="card card-dashboard">
                    <div class="card-body text-center">
                        <div style="font-size: 3rem;">üìã</div>
                        <h5 class="card-title mt-2">Listar Pacientes</h5>
                        <p class="card-text">Ver todos mis pacientes</p>
                        <button class="btn btn-primary-custom w-100" onclick="listarPacientes()">
                            Ver Listado
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-4 mb-3">
                <div class="card card-dashboard">
                    <div class="card-body text-center">
                        <div style="font-size: 3rem;">üìä</div>
                        <h5 class="card-title mt-2">Estad√≠sticas</h5>
                        <p class="card-text">Reportes y an√°lisis</p>
                        <button class="btn btn-primary-custom w-100" onclick="verEstadisticas()">
                            Ver Estad√≠sticas
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Listado de Pacientes -->
        <div id="patientList" class="card card-dashboard d-none">
            <div class="card-body">
                <h5 class="card-title">üìã Listado de Pacientes</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Documento</th>
                                <th>Nombre Completo</th>
                                <th>Edad</th>
                                <th>√öltima Atenci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="patientTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ==================== CONFIGURACI√ìN ====================
        const API_URL = 'http://192.168.49.2:30800';

        // ==================== VERIFICAR AUTENTICACI√ìN ====================
        function checkAuth() {
            const token = sessionStorage.getItem('token');
            const user = sessionStorage.getItem('user');

            if (!token || !user) {
                window.location.href = 'login.html';
                return false;
            }

            const userData = JSON.parse(user);
            
            if (userData.rol !== 'medico' && userData.rol !== 'admin') {
                alert('Acceso denegado');
                window.location.href = 'login.html';
                return false;
            }

            document.getElementById('userName').textContent = userData.nombres || userData.username;
            return true;
        }

        // ==================== LOGOUT ====================
        function logout() {
            sessionStorage.clear();
            window.location.href = 'login.html';
        }

        // ==================== BUSCAR POR DOCUMENTO ====================
        async function buscarPorDocumento() {
            const documento = document.getElementById('searchDoc').value.trim();
            
            if (!documento) {
                alert('Ingrese un n√∫mero de documento');
                return;
            }

            const token = sessionStorage.getItem('token');
            
            try {
                const response = await fetch(`${API_URL}/pacientes/${documento}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const paciente = await response.json();
                    mostrarResultadoBusqueda([paciente]);
                } else if (response.status === 404) {
                    alert('Paciente no encontrado');
                } else {
                    alert('Error en la b√∫squeda');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            }
        }

        // ==================== BUSCAR POR NOMBRE ====================
        async function buscarPorNombre() {
            const nombre = document.getElementById('searchNombre').value.trim();
            
            if (!nombre) {
                alert('Ingrese un nombre');
                return;
            }

            const token = sessionStorage.getItem('token');
            
            try {
                const response = await fetch(`${API_URL}/pacientes/buscar/query?nombre=${encodeURIComponent(nombre)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const pacientes = await response.json();
                    if (pacientes.length === 0) {
                        alert('No se encontraron pacientes');
                    } else {
                        mostrarResultadoBusqueda(pacientes);
                    }
                } else {
                    alert('Error en la b√∫squeda');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            }
        }

        // ==================== MOSTRAR RESULTADOS ====================
        function mostrarResultadoBusqueda(pacientes) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (pacientes.length === 0) {
                resultsDiv.innerHTML = '<p class="text-muted">No se encontraron resultados</p>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-bordered"><thead><tr><th>Documento</th><th>Nombre</th><th>Edad</th><th>Acciones</th></tr></thead><tbody>';

            pacientes.forEach(p => {
                html += `
                    <tr>
                        <td>${p.numero_documento}</td>
                        <td>${p.nombre_completo || `${p.primer_nombre} ${p.primer_apellido}`}</td>
                        <td>${p.edad || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-info text-white" onclick="verHistoria('${p.numero_documento}')">
                                üìÑ Ver Historia
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            resultsDiv.innerHTML = html;
        }

        // ==================== LISTAR TODOS LOS PACIENTES ====================
        async function listarPacientes() {
            const token = sessionStorage.getItem('token');
            
            try {
                const response = await fetch(`${API_URL}/pacientes?limit=50`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const pacientes = await response.json();
                    mostrarListadoCompleto(pacientes);
                    document.getElementById('totalPacientes').textContent = pacientes.length;
                } else {
                    alert('Error al cargar pacientes');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            }
        }

        // ==================== MOSTRAR LISTADO COMPLETO ====================
        function mostrarListadoCompleto(pacientes) {
            const listDiv = document.getElementById('patientList');
            const tbody = document.getElementById('patientTableBody');
            
            listDiv.classList.remove('d-none');
            
            let html = '';
            pacientes.forEach(p => {
                html += `
                    <tr>
                        <td>${p.numero_documento}</td>
                        <td>${p.nombre_completo || `${p.primer_nombre} ${p.primer_apellido}`}</td>
                        <td>${p.edad || 'N/A'} a√±os</td>
                        <td>${p.fecha_atencion ? new Date(p.fecha_atencion).toLocaleDateString() : 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="verHistoria('${p.numero_documento}')">
                                Ver
                            </button>
                            <button class="btn btn-sm btn-success" onclick="editarHistoria('${p.numero_documento}')">
                                Editar
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="exportarPDF('${p.numero_documento}')">
                                PDF
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // ==================== VER HISTORIA ====================
        function verHistoria(documento) {
            window.location.href = `ver_historia_clinica.html?documento=${documento}`;
        }

        // ==================== EDITAR HISTORIA ====================
        function editarHistoria(documento) {
            window.location.href = `editar_historia_clinica.html?documento=${documento}`;
        }

        // ==================== EXPORTAR PDF ====================
        async function exportarPDF(documento) {
            const token = sessionStorage.getItem('token');
            
            try {
                const response = await fetch(`${API_URL}/pacientes/${documento}/pdf`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `HC_${documento}_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    alert('Error al generar PDF');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            }
        }

        // ==================== VER ESTAD√çSTICAS ====================
        function verEstadisticas() {
            alert('Funcionalidad de estad√≠sticas en desarrollo');
        }

        // ==================== INICIALIZAR ====================
        window.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                listarPacientes();
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Historia Cl铆nica</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            font-family: "Segoe UI", sans-serif;
            min-height: 100vh;
        }
        .navbar-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar-custom .navbar-brand {
            color: white;
            font-weight: 700;
            font-size: 1.5rem;
        }
        .card-main {
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            background: white;
            margin-top: 2rem;
            padding: 2rem;
        }
        .section-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            margin: 1.5rem 0 1rem 0;
        }
        .info-row {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: 600;
            color: #495057;
            width: 200px;
            display: inline-block;
        }
        .info-value {
            color: #212529;
        }
        .btn-pdf {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        .btn-pdf:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }
        .alert-info-custom {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border: none;
            border-radius: 10px;
            padding: 1rem;
        }
        .loading-spinner {
            text-align: center;
            padding: 3rem;
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-custom">
        <div class="container-fluid">
            <span class="navbar-brand"> Mi Historia Cl铆nica</span>
            <div class="d-flex align-items-center">
                <span class="text-white me-3"> <span id="userName"></span></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Cerrar Sesi贸n</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card-main">

            <!-- Loading -->
            <div id="loading" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3 text-muted">Cargando su historia cl铆nica...</p>
            </div>

            <!-- Contenido -->
            <div id="content" class="d-none">
                
                <!-- Header -->
                <div class="text-center mb-4">
                    <h2 class="text-primary fw-bold" id="patientName"></h2>
                    <p class="text-muted">Documento: <span id="patientDoc"></span></p>
                </div>

                <!-- Alerta Info -->
                <div class="alert alert-info-custom">
                    <strong>癸 Informaci贸n:</strong> Esta es su historia cl铆nica personal. Los datos aqu铆 mostrados son confidenciales y est谩n protegidos por la ley.
                </div>

                <!-- Datos Personales -->
                <div class="section-title"> Datos Personales</div>
                <div id="datosPersonales"></div>

                <!-- Condici贸n M茅dica -->
                <div class="section-title">┖ Condici贸n M茅dica Actual</div>
                <div id="condicionMedica"></div>

                <!-- Encuentro -->
                <div class="section-title"> ltima Consulta</div>
                <div id="encuentro"></div>

                <!-- Medicamentos -->
                <div class="section-title"> Medicaci贸n</div>
                <div id="medicamentos"></div>

                <!-- Observaciones -->
                <div class="section-title"> Observaciones M茅dicas</div>
                <div id="observaciones"></div>

                <!-- Botones de Acci贸n -->
                <div class="text-center mt-4">
                    <button class="btn btn-pdf" onclick="descargarPDF()">
                         Descargar Historia en PDF
                    </button>
                </div>

            </div>

            <!-- Sin Datos -->
            <div id="noData" class="d-none text-center py-5">
                <div style="font-size: 5rem;"></div>
                <h4 class="text-muted mt-3">No hay historia cl铆nica registrada</h4>
                <p>A煤n no se ha creado su historia cl铆nica. Consulte con su m茅dico.</p>
            </div>

        </div>
    </div>

    <script>
        // ==================== CONFIGURACIN ====================
        const API_URL = 'http://192.168.49.2:30800';

        let currentDocument = null;

        // ==================== VERIFICAR AUTENTICACIN ====================
        function checkAuth() {
            const token = sessionStorage.getItem('token');
            const user = sessionStorage.getItem('user');

            if (!token || !user) {
                window.location.href = 'login.html';
                return false;
            }

            const userData = JSON.parse(user);
            
            if (userData.rol !== 'paciente') {
                alert('Acceso denegado');
                window.location.href = 'login.html';
                return false;
            }

            document.getElementById('userName').textContent = userData.nombres || userData.username;
            
            // Obtener documento vinculado
            currentDocument = userData.documento_vinculado;
            
            return true;
        }

        // ==================== LOGOUT ====================
        function logout() {
            sessionStorage.clear();
            window.location.href = 'login.html';
        }

        // ==================== CARGAR HISTORIA CLNICA ====================
        async function cargarHistoria() {
            const token = sessionStorage.getItem('token');
            
            if (!currentDocument) {
                document.getElementById('loading').classList.add('d-none');
                document.getElementById('noData').classList.remove('d-none');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/pacientes/${currentDocument}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const paciente = await response.json();
                    mostrarHistoria(paciente);
                } else if (response.status === 404) {
                    document.getElementById('loading').classList.add('d-none');
                    document.getElementById('noData').classList.remove('d-none');
                } else {
                    alert('Error al cargar la historia cl铆nica');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi贸n');
            }
        }

        // ==================== MOSTRAR HISTORIA ====================
        function mostrarHistoria(paciente) {
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('content').classList.remove('d-none');

            // Header
            document.getElementById('patientName').textContent = 
                `${paciente.primer_nombre || ''} ${paciente.segundo_nombre || ''} ${paciente.primer_apellido || ''} ${paciente.segundo_apellido || ''}`.trim();
            document.getElementById('patientDoc').textContent = paciente.numero_documento;

            // Datos Personales
            const datosHTML = `
                <div class="info-row"><span class="info-label">Tipo de Documento:</span><span class="info-value">${paciente.tipo_documento || 'N/A'}</span></div>
                <div class="info-row"><span class="info-label">N煤mero de Documento:</span><span class="info-value">${paciente.numero_documento}</span></div>
                <div class="info-row"><span class="info-label">Fecha de Nacimiento:</span><span class="info-value">${paciente.fecha_nacimiento || 'N/A'}</span></div>
                <div class="info-row"><span class="info-label">Edad:</span><span class="info-value">${paciente.edad || 'N/A'} a帽os</span></div>
                <div class="info-row"><span class="info-label">Sexo:</span><span class="info-value">${paciente.sexo || 'N/A'}</span></div>
                <div class="info-row"><span class="info-label">Grupo Sangu铆neo:</span><span class="info-value">${paciente.grupo_sanguineo || 'N/A'}</span></div>
                <div class="info-row"><span class="info-label">Direcci贸n:</span><span class="info-value">${paciente.direccion_residencia || 'N/A'}</span></div>
                <div class="info-row"><span class="info-label">Municipio:</span><span class="info-value">${paciente.municipio || 'N/A'}</span></div>
                <div class="info-row"><span class="info-label">Tel茅fono:</span><span class="info-value">${paciente.telefono || 'N/A'}</span></div>
                <div class="info-row"><span class="info-label">Correo:</span><span class="info-value">${paciente.correo_electronico || 'N/A'}</span></div>
            `;
            document.getElementById('datosPersonales').innerHTML = datosHTML;

            // Condici贸n M茅dica
            const condicionHTML = paciente.impresion_diagnostica || paciente.diagnostico_definitivo ?
                `<div class="info-row"><span class="info-label">Diagn贸stico:</span><span class="info-value">${paciente.diagnostico_definitivo || paciente.impresion_diagnostica}</span></div>
                 <div class="info-row"><span class="info-label">Estado:</span><span class="info-value">${paciente.estado_egreso || 'Activo'}</span></div>
                 <div class="info-row"><span class="info-label">Alergias:</span><span class="info-value">${paciente.alergias_conocidas || 'Ninguna reportada'}</span></div>` :
                `<p class="text-muted">No hay diagn贸sticos registrados</p>`;
            document.getElementById('condicionMedica').innerHTML = condicionHTML;

            // Encuentro
            const encuentroHTML = paciente.tipo_atencion ?
                `<div class="info-row"><span class="info-label">Tipo de Atenci贸n:</span><span class="info-value">${paciente.tipo_atencion}</span></div>
                 <div class="info-row"><span class="info-label">Fecha:</span><span class="info-value">${paciente.fecha_atencion ? new Date(paciente.fecha_atencion).toLocaleString() : 'N/A'}</span></div>
                 <div class="info-row"><span class="info-label">Motivo:</span><span class="info-value">${paciente.motivo_consulta || 'N/A'}</span></div>
                 <div class="info-row"><span class="info-label">Profesional:</span><span class="info-value">${paciente.nombre_profesional || 'N/A'}</span></div>` :
                `<p class="text-muted">No hay consultas registradas</p>`;
            document.getElementById('encuentro').innerHTML = encuentroHTML;

            // Medicamentos
            const medicamentosHTML = paciente.medicamentos_actuales || paciente.formulacion_medica ?
                `<div class="info-row"><span class="info-label">Medicaci贸n Actual:</span><span class="info-value">${paciente.medicamentos_actuales || paciente.formulacion_medica}</span></div>
                 <div class="info-row"><span class="info-label">Tratamiento:</span><span class="info-value">${paciente.tratamiento_instaurado || 'N/A'}</span></div>` :
                `<p class="text-muted">No hay medicamentos registrados</p>`;
            document.getElementById('medicamentos').innerHTML = medicamentosHTML;

            // Observaciones
            const observacionesHTML = paciente.evolucion_medica || paciente.recomendaciones ?
                `<div class="info-row"><span class="info-label">Evoluci贸n:</span><span class="info-value">${paciente.evolucion_medica || 'N/A'}</span></div>
                 <div class="info-row"><span class="info-label">Recomendaciones:</span><span class="info-value">${paciente.recomendaciones || 'N/A'}</span></div>
                 <div class="info-row"><span class="info-label">Educaci贸n:</span><span class="info-value">${paciente.educacion_paciente || 'N/A'}</span></div>` :
                `<p class="text-muted">No hay observaciones registradas</p>`;
            document.getElementById('observaciones').innerHTML = observacionesHTML;
        }

        // ==================== DESCARGAR PDF ====================
        async function descargarPDF() {
            const token = sessionStorage.getItem('token');
            
            try {
                const response = await fetch(`${API_URL}/pacientes/${currentDocument}/pdf`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Mi_Historia_Clinica_${currentDocument}_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    alert('Error al generar el PDF');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi贸n');
            }
        }

        // ==================== INICIALIZAR ====================
        window.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                cargarHistoria();
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>